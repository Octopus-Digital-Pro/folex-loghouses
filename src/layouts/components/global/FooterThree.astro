---
import config from ".astro/config.generated.json" with { type: "json" };
import { markdownify } from "@/lib/utils/textConverter";
import { splitProtectedText } from "@/lib/utils/splitProtectedText";
import SocialComponent from "@/components/widgets/Social.astro";
import social from "@/config/social.json";
import { useTranslations } from "@/lib/utils/i18nUtils";
import { getEntryCTM } from "@/lib/contentParser.astro";
import { sanity } from "@/lib/sanityClient";
import { urlFor } from "@/lib/sanityImage";
import ContactForm from "../widgets/ContactForm.astro";

const t = await useTranslations(Astro.currentLocale as string);




let {
  copyright,
  footerDescription,
  contactInfo: { address: configAddress, email: configEmail, phone: configPhone },
} = config.settings;
const { footerSpaceTop = true } = Astro.props;

// Sanity footer document (single global footer)
const sanityFooter = await sanity.fetch<{
  title?: string;
  description?: string;
  copyright?: string;
  socials?: Array<{ icon?: { asset?: { _ref?: string } }; url?: string }>;
  address?: string;
  contact?: { phone?: string; email?: string };
} | null>(`*[_type == "footer"][0]{ title, description, copyright, socials, address, contact }`);

// Title & description: Sanity footer > call-to-action section > fallback
const ctaEntry = await getEntryCTM(
  "sections",
  "call-to-action",
  Astro.currentLocale,
);
const title = sanityFooter?.title ?? ctaEntry?.data?.title;
const description = sanityFooter?.description ?? ctaEntry?.data?.description;

// Contact form configuration (optional)
const contactEntry = await getEntryCTM(
  "sections",
  "contact-section",
  Astro.currentLocale,
);
const form = contactEntry?.data?.form;

footerDescription =
  (sanityFooter?.description ? "" : footerDescription) ||
  t("footer.description") ||
  "";

// Copyright: Sanity footer > config
const copyrightText =
  sanityFooter?.copyright ?? copyright?.text ?? t("footer.copyright") ?? "";
const copyrightParts = splitProtectedText(copyrightText);
const showCopyright =
  (sanityFooter ? !!sanityFooter.copyright : config.settings.copyright?.enable) &&
  copyrightParts.length > 0;

// Address & contact: Sanity footer > config
const address = sanityFooter?.address ?? configAddress;
const phone = sanityFooter?.contact?.phone ?? configPhone;
const email = sanityFooter?.contact?.email ?? configEmail;

// Social links: Sanity footer socials (image URLs) > config (React icon names)
const socialList =
  sanityFooter?.socials && sanityFooter.socials.length > 0
    ? sanityFooter.socials.map((item, i) => ({
        enable: true,
        label: `Social ${i + 1}`,
        url: item.url ?? "#",
        icon: item.icon ? urlFor(item.icon).width(32).height(32).url() : "",
      }))
    : social.main.filter((s) => s.enable);
---

<footer
  id="footer-with-contact"
  class:list={["bg-accent", !footerSpaceTop && "mt-0"]}>
  <div class="container pb-8 md:pb-16">
    <div
      class="grid grid-cols-1 gap-y-10 border-b-2 border-black py-16 md:py-24 lg:grid-cols-2 lg:gap-x-20 xl:gap-x-10">
      <div class="space-y-10">
        {
          title && (
            <h2
              class="text-display-6 xs:text-display-5 md:text-display-4"
              set:html={markdownify(title)}
            />
          )
        }
        {
          description && (
            <div
              class="w-full max-w-lg text-lg"
              set:html={markdownify(description, true)}
            />
          )
        }
        <div class="space-y-4">
          {
            showCopyright && (
              <ul class="has-list has-list-slash prose-a:text-inherit flex flex-wrap gap-y-2">
                {copyrightParts.map((value) => (
                  <li class="prose-a:text-text-default/70 prose-a:hover:text-text-default">
                    <span set:html={markdownify(value)} />
                  </li>
                ))}
              </ul>
            )
          }

          <SocialComponent
            size="lg"
            layout="dark"
            class="gap-5"
            linkType="follow"
            list={socialList}
          />
        </div>
      </div>
      <ContactForm form={form} />
    </div>
    <div
      class="font-secondary flex flex-wrap items-center justify-between gap-x-8 gap-y-6 pt-6 text-sm leading-loose font-semibold uppercase">
      {address && <p set:html={markdownify(address)} />}
      <div class="md:text-end">
        {phone && <p set:html={markdownify(phone)} />}
        {email && <p set:html={markdownify(email)} />}
      </div>
    </div>
  </div>
</footer>

