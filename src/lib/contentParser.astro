---
import config from ".astro/config.generated.json" with { type: "json" };
import languages from "@/config/language.json";
import { sanity } from "@/lib/sanityClient";

/**
 * Minimal "CollectionEntry-like" shape so the rest of your app
 * can keep doing page?.data, page.id, etc.
 */
export type CTMEntry<TData = any> = {
  id: string;
  slug?: string;
  data: TData;
};

/**
 * Fetch collection (list) of docs of a given Sanity _type, filtered by language.
 * Keeps similar behavior to your old astro:content version:
 *  - excludes "-index" items by slug convention
 *  - excludes doc.data.draft in production (if you use a `draft` boolean)
 *  - excludes Sanity draft IDs in production
 *  - sorts by `weight` if present
 */
export const getCollectionCTM = async <C extends string>(
  collectionName: C,
  lang: string | undefined,
): Promise<CTMEntry[]> => {
  const { defaultLanguage } = config.settings.multilingual;
  const selectedLanguageCode = lang || defaultLanguage;

  const query = `
    *[
      _type == $type
      && language == $lang
      ${import.meta.env.PROD ? '&& !(_id in path("drafts.**"))' : ""}
    ]{
      _id,
      "slug": slug.current,
      ...
    }
  `;

  const docs = await sanity.fetch<any[]>(query, {
    type: collectionName,
    lang: selectedLanguageCode,
  });

  // Filter out "-index" docs by slug convention (e.g., "homepage-index")
  const pages = (docs ?? []).filter((doc) => {
    const slug = doc?.slug;
    return typeof slug === "string" ? !slug.includes("-index") : true;
  });

  // Prevent generation of pages with `draft: true` in production (your old behavior)
  let cleaned = import.meta.env.PROD ? pages.filter((p) => !p.draft) : pages;

  // Sort by weight if present
  cleaned = cleaned.sort((a, b) => {
    const wa = a.weight ?? Infinity;
    const wb = b.weight ?? Infinity;
    return wa - wb;
  });

  return cleaned.map((doc) => ({
    id: doc._id,
    slug: doc.slug,
    data: doc,
  }));
};

/**
 * Fetch a single entry by type + subCollectionName + language.
 *
 * Your current call pattern:
 *   getEntryCTM("homepage", "-index", Astro.currentLocale)
 *
 * This maps to slug:
 *   "homepage-index"
 *
 * If you later want to fetch by a normal slug, you can pass it as:
 *   getEntryCTM("page", "about", "en")
 */
export const getEntryCTM = async <C extends string>(
  collectionName: C,
  subCollectionName: string,
  lang?: string,
): Promise<CTMEntry | null> => {
  const { defaultLanguage } = config.settings.multilingual;
  const selectedLanguageCode = lang || defaultLanguage;

  const normalizedSub = (subCollectionName ?? "").trim();

  // Map your old convention to a Sanity slug
  // "-index" => `${type}-index`
  const slug = normalizedSub.startsWith("-")
    ? `${collectionName}${normalizedSub}`
    : normalizedSub.replace(/^\//, "");

  const query = `
    *[
      _type == $type
      && language == $lang
      && slug.current == $slug
      ${import.meta.env.PROD ? '&& !(_id in path("drafts.**"))' : ""}
    ][0]{
      _id,
      "slug": slug.current,
      ...
    }
  `;

  const doc = await sanity.fetch<any | null>(query, {
    type: collectionName,
    lang: selectedLanguageCode,
    slug,
  });

  if (!doc) return null;

  // Optional: keep your old "draft flag" behavior too
  if (import.meta.env.PROD && doc.draft) return null;

  return {
    id: doc._id,
    slug: doc.slug,
    data: doc,
  };
};
---
