---
import Base from "@/layouts/Base.astro";
import { generatePaths } from "@/lib/utils/i18nUtils";
import { sanity } from "@/lib/sanityClient";
import { urlFor } from "@/lib/sanityImage";
import { portableTextToHtml } from "@/lib/portableText";

import Clients from "@/components/sections/Clients.astro";
import BannerAgencyStartup from "@/components/sections/Banner.astro";
import PricingSection from "@/components/sections/PricingSection.astro";
import ServicesSection from "@/components/sections/ServicesSection.astro";
import PortfolioSection from "@/components/sections/PortfolioSection.astro";

export function getStaticPaths() {
  return generatePaths();
}

// Fetch home page from Sanity
const page = await sanity.fetch(
  `*[_type == "homePage" && slug.current == $slug][0]`,
  { slug: "/" },
);

const hero =
  page?.sections?.find((section: any) => section._type === "hero") ?? null;

const infoBlock =
  page?.sections?.find((section: any) => section._type === "infoBlock") ?? null;

const accordionSection =
  page?.sections?.find((section: any) => section._type === "accordion") ?? null;

const clientsSection =
  page?.sections?.find((section: any) => section._type === "clients") ?? null;

// Portable Text blocks â†’ plain text (for description)
function portableTextToPlainText(blocks: { children?: { text?: string }[] }[] | undefined): string {
  if (!Array.isArray(blocks) || blocks.length === 0) return "";
  return blocks
    .map((block) =>
      Array.isArray(block.children)
        ? block.children.map((c) => c?.text ?? "").join("")
        : "",
    )
    .filter(Boolean)
    .join("\n\n");
}

// Map Sanity hero to Banner.astro content shape (title, image URL, description, etc.)
const heroBannerContent =
  hero &&
  ({
    title: [hero.preTitle, hero.title].filter(Boolean).join("").trim() || undefined,
    description: portableTextToPlainText(hero.description) || undefined,
    image: hero.media ? urlFor(hero.media).width(1200).height(800).url() : undefined,
  });

// Map Sanity accordion to PortfolioSection.astro content shape (title + items with HTML description)
const accordionContent =
  accordionSection &&
  Array.isArray(accordionSection.items) &&
  accordionSection.items.length > 0
    ? {
        enable: true,
        title: accordionSection.title ?? undefined,
        items: accordionSection.items.map((item: any) => ({
          title: item.title ?? "",
          description: portableTextToHtml(item.description),
        })),
      }
    : null;

// Map Sanity clients to Clients.astro content shape (enable, title, list with src URLs, options)
const clientsContent =
  clientsSection &&
  Array.isArray(clientsSection.list) &&
  clientsSection.list.length > 0
    ? {
        enable: clientsSection.enable ?? true,
        title: clientsSection.title ?? undefined,
        list: clientsSection.list.map((item: any) => ({
          src: item.src ? urlFor(item.src).url() : "",
          alt: item.alt ?? "",
        })),
        options: clientsSection.options ?? {},
      }
    : null;

---

<Base {...(page || {})} headerPosition="fixed" hasHeaderDarkBackground={true}>
  {
    heroBannerContent && (
      <BannerAgencyStartup content={heroBannerContent} />
    )
  }

  {
    infoBlock && (
      <section class="bg-white py-20 md:py-28">
        <div class="container mx-auto grid gap-10 px-4 md:grid-cols-2 md:items-center">
          {
            infoBlock.media && (
              <div>
                <img
                  src={urlFor(infoBlock.media).width(900).height(700).url()}
                  alt={infoBlock.media.alt || infoBlock.title || "Log house details"}
                  class="h-full w-full rounded-xl object-cover shadow-xl"
                  loading="lazy"
                />
              </div>
            )
          }

          <div class="space-y-4">
            {infoBlock.preTitle && (
              <p class="text-sm font-semibold uppercase tracking-[0.2em] text-gray-500">
                {infoBlock.preTitle}
              </p>
            )}

            {infoBlock.title && (
              <h2 class="text-3xl font-semibold text-gray-900 md:text-4xl">
                {infoBlock.title}
              </h2>
            )}

            {
              Array.isArray(infoBlock.description) &&
                infoBlock.description.length > 0 && (
                  <p class="mt-4 text-base leading-relaxed text-gray-600">
                    {
                      infoBlock.description
                        .map((block: any) =>
                          Array.isArray(block.children)
                            ? block.children.map((child: any) => child.text).join("")
                            : "",
                        )
                        .join("\n\n")
                    }
                  </p>
                )
            }

            {
              infoBlock.button?.label && infoBlock.button?.href && (
                <div class="mt-6">
                  <a
                    href={infoBlock.button.href}
                    class="inline-flex items-center rounded-full bg-black px-6 py-3 text-sm font-semibold text-white shadow-lg transition hover:bg-gray-900"
                  >
                    {infoBlock.button.label}
                  </a>
                </div>
              )
            }
          </div>
        </div>
      </section>
    )
  }

  <Clients content={clientsContent ?? undefined} />
  <ServicesSection />
  <PortfolioSection content={accordionContent ?? undefined} />
  <PricingSection />
</Base>
